/**
 * Host Bubble JavaScript - April 2026 Production Spec
 * Total size: < 6KB gzipped
 * Zero external dependencies
 */

(function() {
  'use strict';

  // Configuration
  const CONFIG = {
    SPEECH_API: '/api/speak',
    WS_ENDPOINT: `ws://${window.location.host}/ws/ai-comms`,
    WAKE_WORD: 'cali',
    RECONNECT_DELAY: 5000,
    SPEECH_TIMEOUT: 10000
  };

  // State management
  let state = {
    isListening: false,
    isMuted: false,
    isConnected: false,
    recognition: null,
    websocket: null,
    reconnectTimeout: null,
    speechTimeout: null
  };

  // DOM elements
  const elements = {
    orb: document.getElementById('cali-orb'),
    panel: document.getElementById('cali-panel'),
    messages: document.getElementById('cali-messages')
  };

  // Speech Recognition Setup
  function initSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      console.warn('Speech recognition not supported');
      return false;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    state.recognition = new SpeechRecognition();

    state.recognition.continuous = false;
    state.recognition.interimResults = false;
    state.recognition.lang = 'en-US';

    state.recognition.onstart = function() {
      state.isListening = true;
      elements.orb.classList.add('listening');
      addMessage('ðŸŽ¤ Listening...', 'system');
    };

    state.recognition.onend = function() {
      state.isListening = false;
      elements.orb.classList.remove('listening');
    };

    state.recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript.toLowerCase().trim();
      handleTranscript(transcript);
    };

    state.recognition.onerror = function(event) {
      console.error('Speech recognition error:', event.error);
      addMessage('âŒ Speech recognition error', 'error');
    };

    return true;
  }

  // WebSocket Management
  function initWebSocket() {
    if (state.websocket && state.websocket.readyState === WebSocket.OPEN) {
      return;
    }

    try {
      state.websocket = new WebSocket(CONFIG.WS_ENDPOINT);

      state.websocket.onopen = function() {
        state.isConnected = true;
        console.log('Cali WebSocket connected');
        clearTimeout(state.reconnectTimeout);
      };

      state.websocket.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        } catch (e) {
          console.error('WebSocket message parse error:', e);
        }
      };

      state.websocket.onclose = function() {
        state.isConnected = false;
        console.log('Cali WebSocket disconnected');
        scheduleReconnect();
      };

      state.websocket.onerror = function(error) {
        console.error('WebSocket error:', error);
        state.isConnected = false;
      };

    } catch (e) {
      console.error('WebSocket initialization error:', e);
      scheduleReconnect();
    }
  }

  function scheduleReconnect() {
    if (state.reconnectTimeout) return;

    state.reconnectTimeout = setTimeout(() => {
      state.reconnectTimeout = null;
      initWebSocket();
    }, CONFIG.RECONNECT_DELAY);
  }

  // Message Handling
  function handleTranscript(transcript) {
    console.log('Transcript:', transcript);

    if (transcript.includes(CONFIG.WAKE_WORD)) {
      activateCali();
      return;
    }

    // Send to WebSocket if connected and Cali is active
    if (state.isConnected && !elements.panel.classList.contains('hidden')) {
      sendToWebSocket({
        type: 'speech_input',
        transcript: transcript,
        timestamp: new Date().toISOString()
      });
    }
  }

  function handleWebSocketMessage(data) {
    switch (data.type) {
      case 'ai_response':
        if (data.response) {
          speakResponse(data.response);
        }
        break;
      case 'comms_connected':
        addMessage('âœ… Cali connected', 'system');
        break;
      case 'error':
        addMessage('âŒ ' + (data.message || 'Unknown error'), 'error');
        break;
      default:
        console.log('Unhandled WebSocket message:', data);
    }
  }

  function sendToWebSocket(data) {
    if (state.websocket && state.websocket.readyState === WebSocket.OPEN) {
      state.websocket.send(JSON.stringify(data));
    } else {
      addMessage('âš ï¸ Connection lost, retrying...', 'warning');
      initWebSocket();
    }
  }

  // UI Management
  function activateCali() {
    elements.panel.classList.remove('hidden');
    addMessage('ðŸ‘‘ Cali_X_One activated', 'cali');
    speakResponse('Cali online. How may I assist you?');

    // Auto-hide after 30 seconds of inactivity
    setTimeout(() => {
      if (!state.isListening) {
        deactivateCali();
      }
    }, 30000);
  }

  function deactivateCali() {
    elements.panel.classList.add('hidden');
    addMessage('ðŸ”„ Returned to worker team', 'system');
  }

  function addMessage(text, type = 'message') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `cali-message cali-${type}`;
    messageDiv.textContent = text;
    elements.messages.appendChild(messageDiv);
    elements.messages.scrollTop = elements.messages.scrollHeight;

    // Auto-cleanup old messages
    const messages = elements.messages.children;
    if (messages.length > 50) {
      elements.messages.removeChild(messages[0]);
    }
  }

  // Speech Synthesis
  function speakResponse(text) {
    if (state.isMuted) return;

    // Use Web Speech API as fallback
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.9;
      utterance.pitch = 1.0;
      utterance.volume = 0.8;

      // Try to find a female voice
      const voices = speechSynthesis.getVoices();
      const preferredVoice = voices.find(voice =>
        voice.name.toLowerCase().includes('female') ||
        voice.name.toLowerCase().includes('karen') ||
        voice.name.toLowerCase().includes('samantha')
      );

      if (preferredVoice) {
        utterance.voice = preferredVoice;
      }

      speechSynthesis.speak(utterance);

      utterance.onstart = () => addMessage('ðŸ”Š ' + text, 'speech');
      utterance.onend = () => {
        // Small delay before allowing new speech
        setTimeout(() => {
          if (!state.isListening && !state.speechTimeout) {
            startListening();
          }
        }, 500);
      };
    } else {
      addMessage('ðŸ”Š ' + text, 'speech');
    }
  }

  // Speech Recognition Control
  function startListening() {
    if (state.isMuted || state.isListening) return;

    try {
      state.recognition.start();
    } catch (e) {
      console.error('Failed to start speech recognition:', e);
      // Retry after a short delay
      setTimeout(startListening, 1000);
    }
  }

  function stopListening() {
    if (state.recognition && state.isListening) {
      state.recognition.stop();
    }
  }

  // Event Listeners
  function setupEventListeners() {
    // Orb click - toggle mute
    elements.orb.addEventListener('click', function(e) {
      e.preventDefault();
      state.isMuted = !state.isMuted;
      elements.orb.classList.toggle('muted', state.isMuted);

      if (state.isMuted) {
        stopListening();
        addMessage('ðŸ”‡ Muted', 'system');
      } else {
        addMessage('ðŸ”Š Unmuted', 'system');
        startListening();
      }
    });

    // Panel click - prevent closing when clicking inside
    elements.panel.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    // Global click - close panel when clicking outside
    document.addEventListener('click', function(e) {
      if (!elements.panel.contains(e.target) && !elements.orb.contains(e.target)) {
        deactivateCali();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        deactivateCali();
      }
    });
  }

  // Initialization
  function init() {
    console.log('Initializing Cali Host Bubble...');

    // Initialize speech recognition
    if (!initSpeechRecognition()) {
      addMessage('âš ï¸ Speech recognition not available', 'warning');
    }

    // Initialize WebSocket
    initWebSocket();

    // Setup event listeners
    setupEventListeners();

    // Start listening after a short delay
    setTimeout(() => {
      if (!state.isMuted) {
        startListening();
      }
    }, 1000);

    console.log('Cali Host Bubble initialized');
  }

  // Start when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Export minimal API for debugging
  window.CaliBubble = {
    activate: activateCali,
    deactivate: deactivateCali,
    speak: speakResponse,
    mute: () => { state.isMuted = true; elements.orb.classList.add('muted'); },
    unmute: () => { state.isMuted = false; elements.orb.classList.remove('muted'); startListening(); }
  };

})();