# Minimal DALS Stack - Cali_X_One Integration Only
# Sovereign AI - No UCM, No external dependencies
# Use: docker-compose -f docker-compose.minimal.yml up -d

version: '3.8'

services:
  # ============================================================================
  # DALS CORE SERVICES - Cali_X_One Integrated
  # ============================================================================

  # DALS Controller Service (Main ISS Module)
  dals-controller:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: dals-controller:v1.0.0
    container_name: dals-controller
    ports:
      - "8003:8003"  # API Gateway
      - "8008:8008"  # Dashboard Server
    environment:
      - ENVIRONMENT=production
      - ISS_SERVICE_NAME=dals-controller
      - ISS_HOST=0.0.0.0
      - ISS_PORT=8003
      - DASHBOARD_PORT=8008
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
      - CALI_X_ONE_INTEGRATION_READY=true
      - REDIS_URL=redis://redis:6379
      - REDIS_ENABLED=true
      - MODULE_STATUS_TRACKING=true
      - WEBSOCKET_ENABLED=true
      - DALS_001_ENFORCED=true
      # Phase 11-A2: Autonomous Predictive Prevention
      - PREDICTIVE_ENGINE_ENABLED=true
      - AUTONOMOUS_PREVENTION_MODE=11-A2
      - PREDICTIVE_SCAN_INTERVAL=5
      - RISK_THRESHOLD_HIGH=70
      - RISK_THRESHOLD_CRITICAL=90
      - SELF_MODEL_ENABLED=true
      - AWARENESS_LAYER_ACTIVE=true
      - VOICE_AWARENESS_ENABLED=true
      - CANS_AUTONOMOUS_MODE=aggressive
      - PREDICTIVE_FAILURE_MODELING=true
      - HEALTH_TREND_ANALYSIS=true
      - PREVENTION_PROTOCOLS_ACTIVE=true
      # Cali_X_One Voice AI Integration
      - CALI_X_ONE_ENABLED=true
      - CALI_VOICE_ENGINE=gtts
      - CALI_SECURITY_LAYER=active
      - CALI_METAMASK_INTEGRATION=true
      # Minting Plugins (now internal modules)
      - ALPHA_CERTSIG_PLUGIN_ENABLED=true
      - TRUEMARK_PLUGIN_ENABLED=true
      - LIVE_MINTING_ENABLED=true
    volumes:
      - ./iss_module/data:/app/data
      - ./vault:/app/vault
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ./iss_module/cali_x_one:/app/cali_x_one  # Cali_X_One voice AI integration
    depends_on:
      - redis
    networks:
      - dals-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Redis for caching and session storage
  redis:
    image: redis:7.2-alpine
    container_name: dals-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - dals-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  # ============================================================================
  # COGNITIVE SERVICES - Cali_X_One Only
  # ============================================================================

  # Cali_X_One Voice AI Integration (Sovereign AI - No UCM)
  # Integrated directly into DALS controller via volume mount
  # Provides voice commands and MetaMask-signed identity verification

networks:
  dals-network:
    driver: bridge

volumes:
  redis_data:
